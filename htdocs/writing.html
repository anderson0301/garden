<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><title>執筆用 | ●●● | マイホームブログ | Web屋の芝生DIY</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="/shared/css/basic.css" media="all"></head><body class="lyt-main-sub turf"><div id="content"><main><div id="main-inner"><p class="main-visual"><img src="/wp-content/uploads/thum-turf.jpg" alt=""></p>


<!--======================================ここから記事用ソース======================================-->

<p>先日からGoogle Search ConsoleでいくつかのAMPページでエラーが発生していることが確認されました。原因を調べたところ、どうやら3月14日にアップデートした、Amazonアソシエイトのリンクを生成するWordPressのプラグイン<strong>「Associates Link Builder 1.6.0」が悪さしている模様。</strong></p>
[adsense_top]
<p>おそらくWordPressでAMPページを実装しかつプラグインを使っている人は同じ事象に出くわしている人も多いのではないでしょうか。そこで本記事では、同バージョンのAssociates Link Builderを利用していてもAMPエラーが発生しないようにする方法をご紹介したいと思います。</p>
<h2 class="hdg-l2-01">AMPエラーの内容について</h2>
<p>Google Search Consoleでエラーが出ているのでおやと思い確認すると、以下のエラーが複数のページで通知されていました。</p>
<blockquote>
<p>AMPドキュメントでインラインの「style」属性を使用することはできません。「style amp-custom」タグを代わりに使用してください。</p>
</blockquote>
<p>インラインでスタイル書いた覚えなんてないぞと思い、該当のページのソースを確認したところ以下の記述を発見。</p>
<pre><code>&lt;img src=&quot;https://ir-jp.amazon-adsystem.com/XXX&quot; width=&quot;1px&quot; height=&quot;1px&quot; alt=&quot;&quot; style=&quot;position: fixed !important; bottom: -1px !important; right: -1px !important; border:none !important; margin:0px !important;&quot; /&gt;</code></pre>
<p>プラグインで生成しているAmazonアソシエイトのリンクの先頭に記述されていました。1pxの透明画像のようです。プラグインの導入時は確かになかったので、間違いなくバージョンアップした1.6.0の影響だろうとすぐに察知。</p>
<p>プラグインのファイルを検索すると、以下のファイルに該当の記述を発見しました。</p>
<pre><code>/wp-content/plugins/amazon-associates-link-builder/lib/php/aalb_impression_generator.php</code></pre>
<p>上記ファイルの中身を見ると、たしかに同様のインラインスタイルで書かれたソースが確認できます。</p>
<pre><code>return '&lt;img src=&quot;' . $image_url . '&quot; width=&quot;1px&quot; height=&quot;1px&quot; alt=&quot;&quot; style=&quot;position: fixed !important; bottom: -1px !important; right: -1px !important; border:none !important; margin:0px !important;&quot; /&gt;';</code></pre>
<h2 class="hdg-l2-01">対処方法</h2>
<p>対象方法は2パターンあります。1つ目は、以下のようにimgタグ自体生成されないようにする方法です。</p>
<pre><code>return '';</code></pre>
<p>もしくは以下のようにインラインスタイルを削除するだけでもエラーは解消することができます。</p>
<pre><code>return '&lt;img src=&quot;' . $image_url . '&quot; width=&quot;1px&quot; height=&quot;1px&quot; alt=&quot;&quot; /&gt;';</code></pre>
<ul class="list-notice-01">
<li><span>※</span>念のため編集の際は自己責任でお願い致します</li>
</ul>
<h2 class="hdg-l2-01">何のためのソースなのか？</h2>
<p>プラグインの公式サイトの変更履歴を見ると、以下のように記載されています。</p>
<ul class="list-link-01">
<li><a href="https://ja.wordpress.org/plugins/amazon-associates-link-builder/#developers" target="_blank">Amazon Associates Link Builder &mdash; WordPressプラグイン</a></li>
</ul>
<blockquote>
<p>Added Impressions data in reports shown on respective associates website. This will work only for ads rendered after upgrade to this release.</p>
</blockquote>
<p>直訳すると以下のような感じです。</p>
<blockquote>
<p>表示レポートにインプレッションデータを追加しました。これは、このリリースへのアップグレード後にレンダリングされた広告に対してのみ機能します。</p></p>
</blockquote>
<p>phpファイルの中身にもコメントアウトで「impression tracking〜」と記載があるので、Amazon側でトラッキングするためのソースと解釈しました。</p>
<p>はっきり言って1pxとはいえdisplay:none;されているわけでもないのでデザインに影響する以上、ちょっとあまりいい気分じゃありませんね。。。</p>
<p>しかも<strong>「アップグレード後にレンダリングされた」</strong>ということは実質全てのリンクに影響するということです。</p>
<ul class="list-notice-01">
<li><span>※</span>実際かなり過去のページにも影響を及ぼしました</li>
</ul>
<p>1pxだけ領域を保持するだけならまだしも、Web屋の芝生DIYのAMPページではこれのおかげでエラー発生だけでなく、びっくりするくらいレイアウト崩れを起こしてしまったので、というかAMP対応している人全滅でしょこれというような機能追加のされ方をしている点について、そのあたりどう考えていたのか開発者に小一時間問い詰めたいところです。</p>
<h2 class="hdg-l2-01">まとめ</h2>
<p>冒頭で述べた通り、Associates Link Builder 1.6.0を利用し、かつAMP対応をされているサイトは影響を受ける可能性が高いと思われます。Amazon側でトラッキングするためのもののようなので、特にこのphpを改変しても動作に影響することはありません。</p>
<ul class="list-notice-01">
<li><span>※</span>しつこいようですが、編集の際は自己責任でお願い致します</li>
</ul>
<p>本記事が同事象に遭遇された方のご参考になれば幸いです。</p>

<!--======================================ここまで記事用ソース======================================-->

<!--
<p><img src="/images/blog/2018/02/XX_01_XX.jpg" alt="" width="660" height=""></p>
<h2 class="hdg-l2-01">まとめ</h2>
<p></p>
-->

</div><!--/#main-inner--></main></div><!--/#content--><p class="page_top"><a href="#">ページの先頭に戻る</a></p><footer><p>&copy;2016 Web屋の芝生DIY All rights reserved.</p></footer><script src="//code.jquery.com/jquery-2.2.4.min.js"></script><script src="/shared/js/init.js"></script><script></script></body></html>