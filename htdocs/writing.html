<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><title>執筆用 | ●●● | マイホームブログ | Web屋の芝生DIY</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="/shared/css/basic.css" media="all"></head><body class="lyt-main-sub turf"><div id="content"><main><div id="main-inner"><p class="main-visual"><img src="/wp-content/uploads/thum-turf.jpg" alt=""></p>


<!--======================================ここから記事用ソース======================================-->

<p>jQueryの$.ajax()を利用して別のページから要素を取得する際、取得先が1ページであればさほど問題はないのですが、複数ページから取得しかつ順序を保証して表示する場合はちょっとしたコツが必要です。個人的にハマったので、複数ページからの要素取得において順序を保証する実装方法のポイントをまとめてみました。</p>
[adsense_top]
<h2 class="hdg-l2-01">サンプルコード</h2>
<p>3パターン、サンプルを用意してみました。</p>
<ul class="list-bullet-01">
<li>順序が保証されないパターン（iが常に最大値かつ順序不定）</li>
<li>順序が保証されないパターン（iは正しく処理されるも順序不定）</li>
<li>順序が保証されるパターン</li>
</ul>
<p>処理としては下記3ページのh1テキストを取得し、実行順序を検証用としてDOM生成しています。</p>
<ul class="list-link-01">
<li><a href="/about/">サイトについて</a></li>
<li><a href="/contact/">お問い合わせ</a></li>
<li><a href="/sitemap/">サイトマップ</a></li>
</ul>
<h4 class="hdg-l4-01">以下のように表示されれば成功</h4>
<ul class="list-bullet-01">
<li>（0）サイトについて</li>
<li>（1）お問い合わせ</li>
<li>（2）サイトマップ</li>
</ul>
<p>では、それぞれのサンプルを見ていきたいと思います。</p>
<h3 class="hdg-l3-01">順序が保証されないパターン（iが常に最大値かつ順序不定）</h3>
<h4 class="hdg-l4-01">HTML</h4>
<pre><code>&lt;div class=&quot;hoge&quot;&gt;
&lt;ul class=&quot;list-bullet-01&quot;&gt;
&lt;/ul&gt;
&lt;/div&gt;</code></pre>
<h4 class="hdg-l4-01">js</h4>
<pre><code>$(function(){
  var $ajaxURLArr = [
    '/about/',
    '/contact/',
    '/sitemap/'
  ];
  for(var i = 0; i < $ajaxURLArr.length; i++){
    $.ajax({
      type:'GET',
      url:$ajaxURLArr[i],
      dataType:'html'
    })
    .then(
      /*読み込み成功時*/
      function(data){
        var $heading = $(data).find('h1.hdg-l1-01').find('span').text();
        var $headingDOM = '&lt;li&gt;（' + i + '）' + $heading +'&lt;/li&gt;';
        $('.hoge ul.list-bullet-01').append($headingDOM);
      },
      /*読み込み失敗時*/
      function(){
        alert("読み込み失敗");
    });
  }
});</code></pre>
<ul class="list-notice-01">
<li><span>※</span><a href="https://jquery.com/" target="_blank" class="blank">jQuery</a>を読み込んでいる場合のスクリプトとなります</li>
</ul>
<h4 class="hdg-l4-01">解説</h4>
<p>以降のサンプル全て同様ですが、配列「$ajaxURLArr」に格納した3つのURLに対し、for文を回して$.ajax()で要素を取得します。取得した値は&lt;li&gt;（i）～&lt;/li&gt;であらかじめ用意したhtmlにappend()します。</p>
<p>本サンプルの場合要素自体は取得できますが、DOM生成した変数iが全て最大値となってしまい、順序も不定になります。例えば、</p>
<ul class="list-bullet-01">
<li>（3）お問い合わせ</li>
<li>（3）サイトについて</li>
<li>（3）サイトマップ</li>
</ul>
<p>だったり、</p>
<ul class="list-bullet-01">
<li>（3）サイトマップ</li>
<li>（3）お問い合わせ</li>
<li>（3）サイトについて</li>
</ul>
<p>のように全ての要素に最大値「3」が付与され、表示順序も読み込みの度に不定となってしまいます。</p>
[adsense_middle]
<h3 class="hdg-l3-01">順序が保証されないパターン（iは正しく処理されるも順序不定）</h3>
<h4 class="hdg-l4-01">HTML</h4>
<pre><code>&lt;div class=&quot;moge&quot;&gt;
&lt;ul class=&quot;list-bullet-01&quot;&gt;
&lt;/ul&gt;
&lt;/div&gt;</code></pre>
<h4 class="hdg-l4-01">js</h4>
<pre><code>$(function(){
  var $ajaxURLArr = [
    '/about/',
    '/contact/',
    '/sitemap/'
  ];
  for(var i = 0; i < $ajaxURLArr.length; i++){
    var $num = i;
    (function(i){
      $.ajax({
        type:'GET',
        url:$ajaxURLArr[i],
        dataType:'html'
      }).then(
        /*読み込み成功時*/
        function(data){
          var $heading = $(data).find('h1.hdg-l1-01').find('span').text();
          var $headingDOM = '&lt;li&gt;（' + i + '）' + $heading +'&lt;/li&gt;';
          $('.moge ul.list-bullet-01').append($headingDOM);
        },
        /*読み込み失敗時*/
        function(){
          alert("読み込み失敗");
      });
    })($num);
  }
});</code></pre>
<ul class="list-notice-01">
<li><span>※</span><a href="https://jquery.com/" target="_blank" class="blank">jQuery</a>を読み込んでいる場合のスクリプトとなります</li>
</ul>
<h4 class="hdg-l4-01">解説</h4>
<p>前述の変数iが最大値になってしまう現象は、forで回す際$.ajax()を無名関数で囲い、変数$numにiを格納し、さらに無名関数に値を渡すことで解決できます。</p>
<p>ただ、番号は「0」「1」「2」と正しく付与されるものの相変わらず実行順序は不定なので、</p>
<ul class="list-bullet-01">
<li>（1）お問い合わせ</li>
<li>（0）サイトについて</li>
<li>（2）サイトマップ</li>
</ul>
<p>だったり、</p>
<ul class="list-bullet-01">
<li>（2）サイトマップ</li>
<li>（1）お問い合わせ</li>
<li>（0）サイトについて</li>
</ul>
<p>のように、やはり表示される順序は保証されません。</p>
<h3 class="hdg-l3-01">順序が保証されるパターン</h3>
<p>前置きが長くなりましたが、こちらが表示順序が保証されるパターンです。</p>
<h4 class="hdg-l4-01">HTML</h4>
<pre><code>&lt;div class=&quot;fuga&quot;&gt;
&lt;ul class=&quot;list-bullet-01&quot;&gt;
&lt;/ul&gt;
&lt;/div&gt;</code></pre>
<h4 class="hdg-l4-01">js</h4>
<pre><code>$(function(){
  var $ajaxURLArr = [
    '/about/',
    '/contact/',
    '/sitemap/'
  ];
  for(var i = 0; i < $ajaxURLArr.length; i++){
    $.ajax({
      type:'GET',
      url:$ajaxURLArr[i],
      dataType:'html',
      <strong>async:false</strong>
    })
    .then(
      /*読み込み成功時*/
      function(data){
        var $heading = $(data).find('h1.hdg-l1-01').find('span').text();
        var $headingDOM = '&lt;li&gt;（' + i + '）' + $heading +'&lt;/li&gt;';
        $('.fuga ul.list-bullet-01').append($headingDOM);
      },
      /*読み込み失敗時*/
      function(){
        alert("読み込み失敗");
    });
  }
});</code></pre>
<ul class="list-notice-01">
<li><span>※</span><a href="https://jquery.com/" target="_blank" class="blank">jQuery</a>を読み込んでいる場合のスクリプトとなります</li>
</ul>
<h4 class="hdg-l4-01">解説</h4>
<p>一見最初のサンプルと変わりませんが、こちらは$.ajax()のオプションに<strong>async:false</strong>の記述を加えています。これによりデフォルトでの非同期ではなく同期での通信が実行され、ファイルの読み込み順が不動になり、結果実行順序を保証されるようになります。</p>
<p>$.ajax()を無名関数で囲う必要もありません。</p>
<h2 class="hdg-l2-01">デモ</h2>
<p>実際に動作を確認できるデモページも公開しておりますのであわせてご確認ください。</p>
<ul class="list-link-01">
<li><a href="/demo/180404_01/" target="_blank">Ajaxで複数ファイルやページから取得した値を処理する方法</a></li>
</ul>
<h2 class="hdg-l2-01">まとめ</h2>
<p>実装目的によって、非同期通信と同期通信を使い分けるとよいです。1ファイルなどであれば、わざわざ同期通信にする必要もありません。また、ご紹介したasync:falseによる同期通信にせずとも、$.when()メソッドを使って非同期通信のまま順番も保証して高速に処理する方法もあるようです。また時間があればサンプル作って検証してみたいと思います。</p>
<p>複数ファイルやページから取得した値を順番を保証して処理したい場合、どうぞ本記事がご参考になれば幸いです。</p>

<!--======================================ここまで記事用ソース======================================-->

<!--
<p><img src="/images/blog/2018/02/XX_01_XX.jpg" alt="" width="660" height=""></p>
<h2 class="hdg-l2-01">まとめ</h2>
<p></p>
-->

</div><!--/#main-inner--></main></div><!--/#content--><p class="page_top"><a href="#">ページの先頭に戻る</a></p><footer><p>&copy;2016 Web屋の芝生DIY All rights reserved.</p></footer><script src="//code.jquery.com/jquery-2.2.4.min.js"></script><script src="/shared/js/init.js"></script><script></script></body></html>